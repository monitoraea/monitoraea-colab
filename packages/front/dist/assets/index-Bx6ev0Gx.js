import{r as c,j as e,u as R,a as O,b as M,c as A,d as $,e as B,f as _,P as q,F as T,C as F,g as D,h as z,i as P,I as W,S as Q,M as C,T as L,D as G,k as K,l as U,m as H,B as J,n as N}from"./index-DLt25zcS.js";import{q as X}from"./styled-components.browser.esm-BtHF474-.js";import{S as Y}from"./Switch-CVR_XOrh.js";var k=new Map,S=new WeakMap,I=0,Z=void 0;function ee(r){return r?(S.has(r)||(I+=1,S.set(r,I.toString())),S.get(r)):"0"}function re(r){return Object.keys(r).sort().filter(function(t){return r[t]!==void 0}).map(function(t){return t+"_"+(t==="root"?ee(r.root):r[t])}).toString()}function te(r){var t=re(r),s=k.get(t);if(!s){var a=new Map,n,h=new IntersectionObserver(function(u){u.forEach(function(i){var o,l=i.isIntersecting&&n.some(function(g){return i.intersectionRatio>=g});r.trackVisibility&&typeof i.isVisible>"u"&&(i.isVisible=l),(o=a.get(i.target))==null||o.forEach(function(g){g(l,i)})})},r);n=h.thresholds||(Array.isArray(r.threshold)?r.threshold:[r.threshold||0]),s={id:t,observer:h,elements:a},k.set(t,s)}return s}function se(r,t,s,a){if(s===void 0&&(s={}),a===void 0&&(a=Z),typeof window.IntersectionObserver>"u"&&a!==void 0){var n=r.getBoundingClientRect();return t(a,{isIntersecting:a,target:r,intersectionRatio:typeof s.threshold=="number"?s.threshold:0,time:0,boundingClientRect:n,intersectionRect:n,rootBounds:n}),function(){}}var h=te(s),u=h.id,i=h.observer,o=h.elements,l=o.get(r)||[];return o.has(r)||o.set(r,l),l.push(t),i.observe(r),function(){l.splice(l.indexOf(t),1),l.length===0&&(o.delete(r),i.unobserve(r)),o.size===0&&(i.disconnect(),k.delete(u))}}function ie(r){var t=r===void 0?{}:r,s=t.threshold,a=t.delay,n=t.trackVisibility,h=t.rootMargin,u=t.root,i=t.triggerOnce,o=t.skip,l=t.initialInView,g=t.fallbackInView,f=c.useRef(),v=c.useState({inView:!!l}),p=v[0],x=v[1],w=c.useCallback(function(b){f.current!==void 0&&(f.current(),f.current=void 0),!o&&b&&(f.current=se(b,function(E,y){x({inView:E,entry:y}),y.isIntersecting&&i&&f.current&&(f.current(),f.current=void 0)},{root:u,rootMargin:h,threshold:s,trackVisibility:n,delay:a},g))},[Array.isArray(s)?s.toString():s,u,h,i,o,n,g,a]);c.useEffect(function(){!f.current&&p.entry&&!i&&!o&&x({inView:!!l})});var m=[w,p.inView,p.entry];return m.ref=m[0],m.inView=m[1],m.entry=m[2],m}function ne({notifications:r,hasMore:t,onMore:s,onSend:a,loading:n,sending:h}){const[u,i]=c.useState(""),[o,l]=c.useState(!1);c.useEffect(()=>{n==="fetched"&&setTimeout(()=>l(!0),3e3)},[n]);const[g,f]=ie({threshold:0});return c.useEffect(()=>{f&&t&&n==="fetched"&&(console.log("load more..."),s())},[f,t,s,n]),e.jsxs("div",{className:"flow",children:[e.jsxs("div",{className:"flow-new",children:[e.jsx("textarea",{placeholder:"Inicie um tópico...",className:"textarea-box",value:u,onChange:v=>i(v.target.value)}),e.jsx("button",{className:"button-primary",disabled:h==="sending",onClick:()=>{a(u),i("")},children:"publicar"})]}),e.jsx("div",{className:"flow-line"}),r.map(v=>{const{id:p,Element:x}=v;return e.jsx(c.Fragment,{children:e.jsx(c.Suspense,{fallback:e.jsx("div",{children:"..."}),children:e.jsx(x,{data:v})})},p)}),n==="fetching"&&e.jsx(e.Fragment,{children:"..."}),o&&e.jsx(ae,{ref:g,children:"..."})]})}const ae=X.div`
    width: 100%;
    margin-top: 5px; 
    position: relative;
`;function ue(){const{server:r}=R(),{user:t}=O(),{currentCommunity:s}=M(),{enqueueSnackbar:a,closeSnackbar:n}=A(),h=$(),{data:u}=B(["following_status"],{queryFn:async()=>(await N.get(`${r}user/${t.id}/following/room_c${s.id}_t1`)).data,enabled:!!t&&!!s}),[i,o]=c.useState(null),[l,g]=c.useState(""),[f,v]=c.useState({}),[p,x]=c.useState(!1),[w,m]=c.useState(null);c.useEffect(()=>{u&&m(u==null?void 0:u.following)},[u]);const b={sendBroadcast:_(()=>N.post(`${r}gt/broadcasting`,{type:i,message:l})),changeFollowing:_(d=>N.put(`${r}user/${t.id}/follow`,{room:`room_c${s.id}_t1`,following:d?1:0,communityId:s.id}),{onSuccess:()=>{h.invalidateQueries("following_status")}})},E=()=>{let d=!1,j={};i||(j.type=!0,d=!0),l.trim().length===0&&(j.message=!0,d=!0),v(j),!d&&x(!0)},y=async()=>{x(!1);const d=a("Enviando...",{persist:!0,anchorOrigin:{vertical:"top",horizontal:"center"}});try{await b.sendBroadcast.mutateAsync(),o(null),g(""),n(d),a("Envio efetuado com sucesso!",{variant:"success",anchorOrigin:{vertical:"top",horizontal:"right"}})}catch(j){n(d),console.error(j),a("Erro ao enviar notificações!",{variant:"error",anchorOrigin:{vertical:"top",horizontal:"right"}})}},V=async d=>{m(d.target.checked),await b.changeFollowing.mutateAsync(d.target.checked)};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"page width-limiter",children:[e.jsx("div",{className:"page-header",children:e.jsx(q,{title:"Conversa"})}),e.jsxs("div",{className:"page-content",children:[e.jsx("div",{className:"page-body",children:e.jsx(T,{isCommunity:!0,children:e.jsx(ne,{})})}),e.jsxs("div",{className:"page-sidebar",children:[e.jsx(F,{title:"sobre o fluxo",children:e.jsxs("p",{className:"pt-1 px-3 pb-3",children:["Este é o fluxo do grupo de trabalho de ",s?s.name:"...",".",w!==null&&e.jsx("div",{children:e.jsx(D,{children:e.jsx(z,{control:e.jsx(Y,{checked:!!w,onChange:V}),label:"Seguindo"})})})]})}),s.id===1&&e.jsxs(F,{title:"Envio de notificação em massa",children:[e.jsx("p",{className:"pt-1 px-3 pb-3",children:e.jsxs(P,{fullWidth:!0,children:[e.jsx(W,{children:"Para quem?"}),e.jsxs(Q,{label:"Para quem?",className:"input-select",value:i||"none",onChange:d=>o(d.target.value),error:f.type,children:[e.jsx(C,{value:"none",children:" -- selecione -- "}),e.jsx(C,{value:"all",children:"Todos os grupos"}),e.jsx(C,{value:"projects",children:"Iniciativas"}),e.jsx(C,{value:"supporters",children:"Facilitadores"})]})]})}),e.jsx("p",{className:"pt-1 px-3 pb-3",children:e.jsx(L,{label:"mensagem",className:"input-text",value:l,onChange:d=>g(d.target.value),multiline:!0,rows:8,error:f.message})}),e.jsx("p",{className:"pt-1 px-3 pb-3",children:e.jsx("button",{className:"button-primary",onClick:E,children:"Enviar"})})]})]})]})]}),e.jsxs(G,{open:p,onClose:()=>x(!1),"aria-labelledby":"alert-dialog-title","aria-describedby":"alert-dialog-description",fullWidth:!0,maxWidth:"sm",children:[e.jsx(K,{id:"alert-dialog-title",children:"Confirmação de envio de notificação em massa"}),e.jsx(U,{id:"alert-dialog-description",children:"O envio de noticações em massa é irreversível!"}),e.jsxs(H,{children:[e.jsx("button",{className:"button-primary",onClick:y,children:"Enviar"}),e.jsx(J,{onClick:()=>x(!1),autoFocus:!0,children:"Cancelar"})]})]})]})}export{ue as default};
